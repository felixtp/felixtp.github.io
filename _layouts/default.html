<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>{% if page.title %}{{ page.title }} - {% endif %}{{ site.title }}</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="{% if page.description %}{{ page.description }}{% else %}{{ site.description }}{% endif %}">
    <meta name="author" content="{% if page.author %}{{ page.author }}{% else %}{{ site.author }}{% endif %}">
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
    
    <!-- Security Meta Tags -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=(), payment=(), usb=()">
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="{% if page.title %}{{ page.title }}{% else %}{{ site.title }}{% endif %}">
    <meta property="og:description" content="{% if page.description %}{{ page.description }}{% else %}{{ site.description }}{% endif %}">
    <meta property="og:type" content="{% if page.layout == 'post' %}article{% else %}website{% endif %}">
    <meta property="og:url" content="{{ page.url | absolute_url }}">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“</text></svg>">
    
    <!-- Typography - Vintage Typewriter Vibes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Vintage Color Palette */
            --text-primary: #2d3436;
            --text-secondary: #636e72;
            --text-tertiary: #a0a0a0;
            --bg-primary: #fefefe;
            --bg-secondary: #f8f7f4;
            --bg-accent: #fff9e6;
            --border-light: #e8e6e3;
            --border-medium: #d1ccc0;
            --accent-color: #6c5ce7;
            --accent-hover: #5f3dc4;
            --vintage-green: #00b894;
            --vintage-amber: #fdcb6e;
            --vintage-rust: #e17055;
            
            /* Typography Scale - Vintage Proportions */
            --font-serif: 'EB Garamond', Georgia, serif;
            --font-mono: 'IBM Plex Mono', 'SF Mono', Monaco, monospace;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem; 
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem;
            --font-size-4xl: 2.25rem;
            
            /* Spacing - Golden Ratio Inspired */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-12: 3rem;
            --space-16: 4rem;
            --space-24: 6rem;
            
            /* Layout */
            --max-width: 720px;
            --border-radius: 3px;
            --shadow-subtle: 0 1px 3px rgba(0,0,0,0.05);
        }

        [data-theme="dark"] {
            --text-primary: #f1f3f4;
            --text-secondary: #9aa0a6;
            --text-tertiary: #6e7074;
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-accent: #2a2a1a;
            --border-light: #404040;
            --border-medium: #595959;
            --accent-color: #a29bfe;
            --accent-hover: #6c5ce7;
            --vintage-green: #00cec9;
            --vintage-amber: #fdcb6e;
            --vintage-rust: #fd79a8;
        }

        /* Dark mode media query support */
        @media (prefers-color-scheme: dark) {
            :root {
                --text-primary: #f1f3f4;
                --text-secondary: #9aa0a6;
                --text-tertiary: #6e7074;
                --bg-primary: #1a1a1a;
                --bg-secondary: #2d2d2d;
                --bg-accent: #2a2a1a;
                --border-light: #404040;
                --border-medium: #595959;
                --accent-color: #a29bfe;
                --accent-hover: #6c5ce7;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-serif);
            line-height: 1.65;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            transition: all 0.3s ease;
            font-size: var(--font-size-lg);
            font-weight: 400;
            letter-spacing: 0.01em;
        }

        /* Typography - Vintage Hierarchy */
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-serif);
            font-weight: 600;
            line-height: 1.2;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        /* About Page - Colourful Vintage Headings */
        .about-page h1 {
            color: var(--vintage-green);
            border-bottom: 2px solid var(--vintage-green);
            padding-bottom: var(--space-2);
            margin-bottom: var(--space-8);
            display: inline-block;
        }

        .about-page h2:nth-of-type(1) { color: var(--vintage-amber); }
        .about-page h2:nth-of-type(2) { color: var(--accent-color); }
        .about-page h2:nth-of-type(3) { color: var(--vintage-rust); }
        .about-page h2:nth-of-type(4) { color: var(--vintage-green); }
        .about-page h2:nth-of-type(5) { color: var(--vintage-amber); }
        .about-page h2:nth-of-type(6) { color: var(--accent-color); }
        .about-page h2:nth-of-type(7) { color: var(--vintage-rust); }

        h1 {
            font-size: var(--font-size-4xl);
            margin-bottom: var(--space-8);
            font-weight: 500;
        }

        h2 {
            font-size: var(--font-size-3xl);
            margin-bottom: var(--space-6);
            margin-top: var(--space-16);
        }

        h3 {
            font-size: var(--font-size-2xl);
            margin-bottom: var(--space-4);
            margin-top: var(--space-12);
        }

        h4 {
            font-size: var(--font-size-xl);
            margin-bottom: var(--space-3);
            margin-top: var(--space-8);
        }

        p {
            margin-bottom: var(--space-6);
            color: var(--text-primary);
        }

        /* Vintage Links */
        a {
            color: var(--accent-color);
            text-decoration: none;
            transition: all 0.2s ease;
            border-bottom: 1px solid transparent;
        }

        a:hover {
            color: var(--accent-hover);
            border-bottom-color: var(--accent-hover);
        }

        /* Monospace Elements */
        code, pre, .mono {
            font-family: var(--font-mono);
            font-size: var(--font-size-sm);
        }

        /* Layout */
        .container {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 0 var(--space-6);
        }

        /* Header - Vintage Newspaper Style */
        header {
            background: var(--bg-primary);
            border-bottom: 2px solid var(--border-medium);
            padding: var(--space-8) 0 var(--space-6) 0;
            position: relative;
        }

        .header-content {
            text-align: center;
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 0 var(--space-6);
        }

        .logo {
            font-family: var(--font-serif);
            font-size: var(--font-size-4xl);
            font-weight: 600;
            color: var(--text-primary);
            text-decoration: none;
            display: block;
            margin-bottom: var(--space-2);
            letter-spacing: -0.02em;
        }

        .tagline {
            font-family: var(--font-mono);
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: var(--space-6);
            letter-spacing: 0.05em;
        }

        .header-divider {
            width: 60px;
            height: 1px;
            background: var(--border-medium);
            margin: var(--space-4) auto;
        }

        /* Navigation - Minimal Vintage */
        nav {
            margin-top: var(--space-4);
        }

        nav ul {
            list-style: none;
            display: flex;
            justify-content: center;
            gap: var(--space-8);
            font-family: var(--font-mono);
            font-size: var(--font-size-sm);
        }

        nav a {
            color: var(--text-secondary);
            text-decoration: none;
            text-transform: lowercase;
            letter-spacing: 0.05em;
            transition: all 0.2s ease;
            border-bottom: 1px solid transparent;
        }

        nav a:hover {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }

        /* Main Content - Spacious and Breathable */
        main {
            padding: var(--space-16) 0;
            min-height: calc(100vh - 200px);
        }

        /* Article Styling - Vintage Typography */
        article {
            margin-bottom: var(--space-24);
        }

        .post-header {
            margin-bottom: var(--space-16);
            text-align: center;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: var(--space-8);
        }

        .post-title {
            font-family: var(--font-serif);
            font-size: var(--font-size-4xl);
            font-weight: 600;
            line-height: 1.2;
            margin-bottom: var(--space-4);
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .post-meta {
            font-family: var(--font-mono);
            color: var(--text-tertiary);
            font-size: var(--font-size-xs);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: var(--space-4);
        }

        .post-stats {
            font-family: var(--font-mono);
            font-size: var(--font-size-xs);
            color: var(--text-tertiary);
            display: flex;
            justify-content: center;
            gap: var(--space-6);
            margin-top: var(--space-2);
        }

        .post-content {
            font-size: var(--font-size-lg);
            line-height: 1.75;
        }

        .post-content p {
            margin-bottom: var(--space-8);
        }

        .post-content blockquote {
            border-left: 3px solid var(--vintage-amber);
            margin: var(--space-16) 0;
            font-style: italic;
            color: var(--text-secondary);
            background: var(--bg-accent);
            padding: var(--space-6);
            border-radius: var(--border-radius);
        }

        .post-content ul, .post-content ol {
            margin-bottom: var(--space-8);
            padding-left: var(--space-6);
        }

        .post-content li {
            margin-bottom: var(--space-2);
        }

        .post-content code {
            font-family: var(--font-mono);
            background: var(--bg-accent);
            padding: 0.15em 0.4em;
            border-radius: var(--border-radius);
            font-size: var(--font-size-sm);
            color: var(--accent-color);
            border: 1px solid var(--border-light);
        }

        .post-content pre {
            font-family: var(--font-mono);
            background: var(--bg-secondary);
            padding: var(--space-6);
            border-radius: var(--border-radius);
            overflow-x: auto;
            margin: var(--space-8) 0;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-subtle);
        }

        .post-content pre code {
            background: none;
            padding: 0;
            border: none;
            color: var(--text-primary);
        }

        /* Home Page - Vintage Newspaper Style */
        .home-intro {
            text-align: center;
            margin-bottom: var(--space-24);
            padding: var(--space-16) 0;
            border-bottom: 2px solid var(--border-medium);
        }

        .home-title {
            font-family: var(--font-serif);
            font-size: var(--font-size-4xl);
            font-weight: 600;
            margin-bottom: var(--space-4);
            letter-spacing: -0.02em;
        }

        .home-subtitle {
            font-family: var(--font-mono);
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-bottom: var(--space-8);
            letter-spacing: 0.05em;
            text-transform: lowercase;
        }

        .home-stats {
            font-family: var(--font-mono);
            font-size: var(--font-size-xs);
            color: var(--text-tertiary);
            display: flex;
            justify-content: center;
            gap: var(--space-8);
            margin-top: var(--space-6);
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            color: var(--vintage-green);
            font-weight: 600;
        }

        /* Blog List - Card Style */
        .blog-posts {
            margin-top: var(--space-16);
        }

        .blog-post {
            margin-bottom: var(--space-16);
            padding: var(--space-8);
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-subtle);
            transition: all 0.2s ease;
        }

        .blog-post:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .blog-post:last-child {
            margin-bottom: 0;
        }

        .blog-post-title {
            font-family: var(--font-serif);
            font-size: var(--font-size-2xl);
            font-weight: 600;
            margin-bottom: var(--space-3);
            line-height: 1.3;
            letter-spacing: -0.01em;
        }

        .blog-post-title a {
            color: var(--text-primary);
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: all 0.2s ease;
        }

        .blog-post-title a:hover {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }

        .blog-post-meta {
            font-family: var(--font-mono);
            font-size: var(--font-size-xs);
            color: var(--text-tertiary);
            margin-bottom: var(--space-4);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .blog-post-excerpt {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: var(--space-4);
        }

        .blog-post-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--space-6);
            padding-top: var(--space-4);
            border-top: 1px solid var(--border-light);
            font-family: var(--font-mono);
            font-size: var(--font-size-xs);
        }

        .post-stats-mini {
            color: var(--text-tertiary);
            display: flex;
            gap: var(--space-4);
        }

        .read-more {
            color: var(--accent-color);
            text-decoration: none;
            font-weight: 500;
            text-transform: lowercase;
            letter-spacing: 0.05em;
        }

        .read-more:hover {
            text-decoration: underline;
        }

        /* Footer - Minimal Vintage */
        footer {
            border-top: 2px solid var(--border-medium);
            padding: var(--space-16) 0;
            text-align: center;
            color: var(--text-tertiary);
            font-family: var(--font-mono);
            font-size: var(--font-size-xs);
            margin-top: var(--space-24);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            :root {
                --max-width: 100%;
                --space-4: 0.75rem;
                --space-6: 1rem;
                --space-8: 1.25rem;
                --space-12: 2rem;
                --space-16: 2.5rem;
                --space-24: 3rem;
            }

            .container {
                padding: 0 var(--space-4);
            }

            .header-content {
                padding: 0 var(--space-4);
            }

            nav ul {
                gap: var(--space-6);
                flex-wrap: wrap;
                justify-content: center;
            }

            .home-title, .post-title {
                font-size: var(--font-size-3xl);
            }

            .logo {
                font-size: var(--font-size-3xl);
            }

            h1 {
                font-size: var(--font-size-3xl);
            }

            h2 {
                font-size: var(--font-size-2xl);
            }

            h3 {
                font-size: var(--font-size-xl);
            }

            .post-content {
                font-size: var(--font-size-base);
            }

            .blog-post {
                padding: var(--space-6);
                margin-bottom: var(--space-12);
            }

            .home-stats {
                flex-direction: column;
                gap: var(--space-4);
            }

            .post-stats {
                flex-direction: column;
                gap: var(--space-2);
            }
        }

        @media (max-width: 480px) {
            :root {
                --space-4: 0.5rem;
                --space-6: 0.75rem;
                --space-8: 1rem;
                --space-12: 1.5rem;
                --space-16: 2rem;
                --space-24: 2.5rem;
            }

            .container {
                padding: 0 var(--space-3);
            }

            .header-content {
                padding: 0 var(--space-3);
            }

            nav ul {
                gap: var(--space-4);
                font-size: var(--font-size-xs);
            }

            .home-title, .post-title {
                font-size: var(--font-size-2xl);
            }

            .logo {
                font-size: var(--font-size-2xl);
            }

            h1 {
                font-size: var(--font-size-2xl);
            }

            h2 {
                font-size: var(--font-size-xl);
            }

            .tagline {
                font-size: var(--font-size-xs);
            }

            .blog-post {
                padding: var(--space-4);
                margin-bottom: var(--space-8);
            }

            .blog-post-footer {
                flex-direction: column;
                gap: var(--space-3);
                text-align: center;
            }
        }

        /* Focus styles for accessibility */
        a:focus,
        button:focus {
            outline: 2px solid var(--accent-color);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <a href="{{ '/' | relative_url }}" class="logo">{{ site.title }}</a>
            <div class="tagline">{{ site.description }}</div>
            <div class="header-divider"></div>
            <nav aria-label="Main navigation">
                <ul>
                    <li><a href="{{ '/' | relative_url }}" {% if page.url == '/' %}class="active"{% endif %}>essays</a></li>
                    <li><a href="{{ '/about/' | relative_url }}" {% if page.url contains '/about/' %}class="active"{% endif %}>about</a></li>
                    <li><a href="{{ '/analytics.html' | relative_url }}" {% if page.url contains '/analytics' %}class="active"{% endif %}>stats</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <div class="container{% if page.url contains '/about/' %} about-page{% endif %}">
            {{ content }}
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; {{ 'now' | date: '%Y' }} {{ site.title }}. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Security: Strict mode
        'use strict';
        
        // Security: Disable eval and Function constructor
        window.eval = function() {
            throw new Error('eval() is disabled for security reasons');
        };
        
        // Theme toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.querySelector('.theme-icon');
            const body = document.body;

            // Check for saved theme preference or default to 'light'
            const currentTheme = localStorage.getItem('theme') || 'light';
            body.setAttribute('data-theme', currentTheme);
            themeIcon.textContent = currentTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';

            themeToggle.addEventListener('click', function() {
                const currentTheme = body.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                body.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                themeIcon.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
            });
        });

        // Security: Remove potentially dangerous global functions
        // Note: Keep XMLHttpRequest for geolocation APIs
        delete window.ActiveXObject;

        // Global Visitor Tracking - Initialize on every page
        class GlobalAnalytics {
            constructor() {
                this.storageKey = 'vintage-blog-analytics';
                this.init();
            }

            init() {
                // Get or create visitor ID
                let visitorId = localStorage.getItem('vintage-visitor-id');
                if (!visitorId) {
                    visitorId = 'visitor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('vintage-visitor-id', visitorId);
                }

                // Load existing data
                let analytics = JSON.parse(localStorage.getItem(this.storageKey) || '{}');
                if (!analytics.visitors) analytics.visitors = {};
                if (!analytics.posts) analytics.posts = {};
                if (!analytics.countries) analytics.countries = {};
                if (!analytics.totalVisitors) analytics.totalVisitors = 0;
                if (!analytics.totalViews) analytics.totalViews = 0;

                // Track this visit
                this.trackVisit(visitorId, analytics);
            }

            async trackVisit(visitorId, analytics) {
                const currentPath = window.location.pathname;
                const isNewVisitor = !analytics.visitors[visitorId];
                
                console.log('ğŸ“Š Tracking visit:', { visitorId, currentPath, isNewVisitor });
                
                // Always detect current session country for accurate geographic tracking
                const currentCountry = await this.detectCountry();
                console.log('ğŸŒ Detected country for this session:', currentCountry);

                // Initialize visitor if new
                if (isNewVisitor) {
                    analytics.totalVisitors++;
                    analytics.visitors[visitorId] = {
                        firstVisit: new Date().toISOString(),
                        visits: 0,
                        countries: {} // Track all countries this visitor has visited from
                    };
                    console.log('ğŸ†• New visitor created');
                }

                // Record this session's country visit
                if (currentCountry && currentCountry.code && currentCountry.code !== 'Unknown') {
                    if (!analytics.visitors[visitorId].countries[currentCountry.code]) {
                        analytics.visitors[visitorId].countries[currentCountry.code] = {
                            name: currentCountry.name,
                            flag: currentCountry.flag,
                            visits: 0,
                            firstSeen: new Date().toISOString()
                        };
                    }
                    analytics.visitors[visitorId].countries[currentCountry.code].visits++;
                    analytics.visitors[visitorId].countries[currentCountry.code].lastSeen = new Date().toISOString();
                    console.log('ğŸŒ Country visit recorded:', currentCountry.code, analytics.visitors[visitorId].countries[currentCountry.code]);
                } else {
                    console.log('âš ï¸ No valid country detected for this session');
                }

                // Increment visit count
                analytics.visitors[visitorId].visits++;
                analytics.totalViews++;

                // Track post views
                if (currentPath.includes('/2025/') || currentPath.includes('/posts/')) {
                    if (!analytics.posts[currentPath]) {
                        analytics.posts[currentPath] = { 
                            views: 0, 
                            title: document.title.replace(' - Felix\'s Digital Garden', '') 
                        };
                    }
                    analytics.posts[currentPath].views++;
                }

                // Update global country tracking - count unique visitors per country
                analytics.countries = {};
                Object.values(analytics.visitors).forEach(visitor => {
                    if (visitor.countries) {
                        Object.entries(visitor.countries).forEach(([countryCode, countryData]) => {
                            if (!analytics.countries[countryCode]) {
                                analytics.countries[countryCode] = {
                                    name: countryData.name,
                                    flag: countryData.flag,
                                    visitors: 0
                                };
                            }
                            analytics.countries[countryCode].visitors++;
                        });
                    }
                });

                console.log('ğŸ“Š Final analytics update:', {
                    totalVisitors: analytics.totalVisitors,
                    totalViews: analytics.totalViews,
                    countries: analytics.countries
                });

                // Save updated analytics
                localStorage.setItem(this.storageKey, JSON.stringify(analytics));
            }

            async detectCountry() {
                try {
                    // Try multiple APIs with better error handling
                    const apis = [
                        'https://ipapi.co/json/',
                        'https://ipinfo.io/json',
                        'https://ip-api.com/json/'
                    ];
                    
                    for (const apiUrl of apis) {
                        try {
                            const response = await fetch(apiUrl, {
                                method: 'GET',
                                headers: { 'Accept': 'application/json' },
                                cache: 'no-cache'
                            });
                            
                            if (response.ok) {
                                const data = await response.json();
                                console.log('ğŸŒ API Response from', apiUrl, ':', data);
                                
                                // Parse different API response formats
                                let countryCode, countryName;
                                
                                if (data.country_code || data.countryCode) {
                                    countryCode = data.country_code || data.countryCode;
                                    countryName = data.country_name || data.country || countryCode;
                                } else if (data.country) {
                                    countryCode = data.country;
                                    countryName = data.country;
                                }
                                
                                if (countryCode && countryCode !== 'Unknown' && countryCode.length === 2) {
                                    const result = {
                                        code: countryCode,
                                        name: countryName || countryCode,
                                        flag: this.getCountryFlag(countryCode)
                                    };
                                    console.log('ğŸŒ Country detected:', result);
                                    return result;
                                }
                            }
                        } catch (apiError) {
                            console.log('ğŸŒ API failed:', apiUrl, apiError);
                            continue;
                        }
                    }

                    console.log('ğŸŒ All APIs failed, using fallback');
                    return { code: 'Unknown', name: 'Unknown', flag: 'ğŸŒ' };
                } catch (error) {
                    console.error('ğŸŒ Country detection completely failed:', error);
                    return { code: 'Unknown', name: 'Unknown', flag: 'ğŸŒ' };
                }
            }

            getCountryFlag(countryCode) {
                if (!countryCode || countryCode === 'Unknown') return 'ğŸŒ';
                
                const flags = {
                    // Major countries
                    'US': 'ğŸ‡ºğŸ‡¸', 'GB': 'ğŸ‡¬ğŸ‡§', 'CA': 'ğŸ‡¨ğŸ‡¦', 'AU': 'ğŸ‡¦ğŸ‡º', 'DE': 'ğŸ‡©ğŸ‡ª',
                    'FR': 'ğŸ‡«ğŸ‡·', 'JP': 'ğŸ‡¯ğŸ‡µ', 'CN': 'ğŸ‡¨ğŸ‡³', 'IN': 'ğŸ‡®ğŸ‡³', 'BR': 'ğŸ‡§ğŸ‡·',
                    'RU': 'ğŸ‡·ğŸ‡º', 'IT': 'ğŸ‡®ğŸ‡¹', 'ES': 'ğŸ‡ªğŸ‡¸', 'NL': 'ğŸ‡³ğŸ‡±', 'SE': 'ğŸ‡¸ğŸ‡ª',
                    'NO': 'ğŸ‡³ğŸ‡´', 'DK': 'ğŸ‡©ğŸ‡°', 'FI': 'ğŸ‡«ğŸ‡®', 'NZ': 'ğŸ‡³ğŸ‡¿', 'IE': 'ğŸ‡®ğŸ‡ª',
                    
                    // European countries
                    'AT': 'ğŸ‡¦ğŸ‡¹', 'BE': 'ğŸ‡§ğŸ‡ª', 'CH': 'ğŸ‡¨ğŸ‡­', 'CZ': 'ğŸ‡¨ğŸ‡¿', 'PL': 'ğŸ‡µğŸ‡±',
                    'PT': 'ğŸ‡µğŸ‡¹', 'GR': 'ğŸ‡¬ğŸ‡·', 'HU': 'ğŸ‡­ğŸ‡º', 'RO': 'ğŸ‡·ğŸ‡´', 'BG': 'ğŸ‡§ğŸ‡¬',
                    'HR': 'ğŸ‡­ğŸ‡·', 'SK': 'ğŸ‡¸ğŸ‡°', 'SI': 'ğŸ‡¸ğŸ‡®', 'EE': 'ğŸ‡ªğŸ‡ª', 'LV': 'ğŸ‡±ğŸ‡»',
                    'LT': 'ğŸ‡±ğŸ‡¹', 'LU': 'ğŸ‡±ğŸ‡º', 'MT': 'ğŸ‡²ğŸ‡¹', 'CY': 'ğŸ‡¨ğŸ‡¾',
                    
                    // Asian countries
                    'KR': 'ğŸ‡°ğŸ‡·', 'TH': 'ğŸ‡¹ğŸ‡­', 'SG': 'ğŸ‡¸ğŸ‡¬', 'MY': 'ğŸ‡²ğŸ‡¾', 'ID': 'ğŸ‡®ğŸ‡©',
                    'PH': 'ğŸ‡µğŸ‡­', 'VN': 'ğŸ‡»ğŸ‡³', 'TW': 'ğŸ‡¹ğŸ‡¼', 'HK': 'ğŸ‡­ğŸ‡°', 'PK': 'ğŸ‡µğŸ‡°',
                    'BD': 'ğŸ‡§ğŸ‡©', 'LK': 'ğŸ‡±ğŸ‡°', 'NP': 'ğŸ‡³ğŸ‡µ', 'MN': 'ğŸ‡²ğŸ‡³', 'KZ': 'ï¿½ï¿½ğŸ‡¿',
                    
                    // Middle East & Africa
                    'IL': 'ğŸ‡®ğŸ‡±', 'AE': 'ğŸ‡¦ğŸ‡ª', 'SA': 'ğŸ‡¸ğŸ‡¦', 'EG': 'ğŸ‡ªğŸ‡¬', 'ZA': 'ğŸ‡¿ğŸ‡¦',
                    'NG': 'ğŸ‡³ğŸ‡¬', 'KE': 'ğŸ‡°ï¿½', 'MA': 'ğŸ‡²ğŸ‡¦', 'ET': 'ğŸ‡ªğŸ‡¹', 'GH': 'ğŸ‡¬ğŸ‡­',
                    'TR': 'ğŸ‡¹ğŸ‡·', 'IR': 'ğŸ‡®ğŸ‡·', 'IQ': 'ï¿½ğŸ‡®ï¿½', 'JO': 'ğŸ‡¯ğŸ‡´', 'LB': 'ğŸ‡±ğŸ‡§',
                    
                    // Americas
                    'MX': 'ğŸ‡²ğŸ‡½', 'AR': 'ğŸ‡¦ğŸ‡·', 'CL': 'ğŸ‡¨ğŸ‡±', 'CO': 'ğŸ‡¨ğŸ‡´', 'PE': 'ğŸ‡µï¿½ğŸ‡ª',
                    'VE': 'ğŸ‡»ğŸ‡ª', 'UY': 'ğŸ‡ºğŸ‡¾', 'EC': 'ğŸ‡ªğŸ‡¨', 'BO': 'ğŸ‡§ğŸ‡´', 'PY': 'ğŸ‡µğŸ‡¾',
                    'CR': 'ğŸ‡¨ğŸ‡·', 'PA': 'ğŸ‡µğŸ‡¦', 'GT': 'ğŸ‡¬ğŸ‡¹', 'CU': 'ğŸ‡¨ğŸ‡º', 'JM': 'ğŸ‡¯ğŸ‡²',
                    
                    // Oceania
                    'FJ': 'ğŸ‡«ğŸ‡¯', 'PG': 'ğŸ‡µğŸ‡¬', 'NC': 'ğŸ‡³ğŸ‡¨', 'VU': 'ğŸ‡»ğŸ‡º', 'SB': 'ğŸ‡¸ğŸ‡§'
                };
                
                return flags[countryCode] || 'ğŸŒ';
            }
        }

        // Initialize global analytics on every page
        const globalAnalytics = new GlobalAnalytics();
    </script>
</body>
</html>